

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>PPG Pre-processing and SQI Calculations using Pandas on multiple Patients &mdash; fyp2021-ph720 0.0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-binder.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-dataframe.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/gallery-rendered-html.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> fyp2021-ph720
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorial</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../tutorials/setup.html">Tutorial</a></li>
</ul>
<p class="caption"><span class="caption-text">Example Galleries</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Example Gallery with some plots</a></li>
</ul>
<p class="caption"><span class="caption-text">Pre Processing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="index.html">Pre Processing</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">fyp2021-ph720</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>PPG Pre-processing and SQI Calculations using Pandas on multiple Patients</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../../_sources/_examples/Pre-processing/plot_SQI_Pandas_on_Multiple_Patients.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="sphx-glr-download-link-note admonition note">
<p class="admonition-title">Note</p>
<p>Click <a class="reference internal" href="#sphx-glr-download-examples-pre-processing-plot-sqi-pandas-on-multiple-patients-py"><span class="std std-ref">here</span></a>
to download the full example code</p>
</div>
<div class="sphx-glr-example-title section" id="ppg-pre-processing-and-sqi-calculations-using-pandas-on-multiple-patients">
<span id="sphx-glr-examples-pre-processing-plot-sqi-pandas-on-multiple-patients-py"></span><h1>PPG Pre-processing and SQI Calculations using Pandas on multiple Patients<a class="headerlink" href="#ppg-pre-processing-and-sqi-calculations-using-pandas-on-multiple-patients" title="Permalink to this headline">Â¶</a></h1>
<p>Trimming, Filtering, Segmentation and SQI Calculations utilising Pandas on Multiple Patients</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="c1"># Code Adapted from:</span>
 <span class="c1"># https://meta00.github.io/vital_sqi/_examples/others/plot_pipeline_02.html</span>
 <span class="c1"># AND</span>
 <span class="c1"># https://meta00.github.io/vital_sqi/_examples/others/plot_read_signal.html#sphx-glr-examples-others-plot-read-signal-py</span>
</pre></div>
</td></tr></table></div>
<p># Importing Libraries</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="c1"># Generic</span>
 <span class="kn">import</span> <span class="nn">os</span>
 <span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
 <span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
 <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
 <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span>
 <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
 <span class="kn">import</span> <span class="nn">glob</span>

 <span class="c1"># Scipy</span>
 <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurtosis</span><span class="p">,</span> <span class="n">entropy</span>
 <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span> <span class="k">as</span> <span class="n">si</span>

  <span class="c1"># vitalSQI</span>
 <span class="kn">from</span> <span class="nn">vital_sqi.data.signal_io</span> <span class="kn">import</span> <span class="n">PPG_reader</span>
 <span class="kn">import</span> <span class="nn">vital_sqi.highlevel_functions.highlevel</span> <span class="k">as</span> <span class="nn">sqi_hl</span>
 <span class="kn">import</span> <span class="nn">vital_sqi.data.segment_split</span> <span class="k">as</span> <span class="nn">sqi_sg</span>
 <span class="kn">from</span> <span class="nn">vital_sqi.common.rpeak_detection</span> <span class="kn">import</span> <span class="n">PeakDetector</span>
 <span class="kn">from</span> <span class="nn">vital_sqi.preprocess.band_filter</span> <span class="kn">import</span> <span class="n">BandpassFilter</span>
 <span class="kn">import</span> <span class="nn">vital_sqi.sqi</span> <span class="k">as</span> <span class="nn">sq</span>

 <span class="n">filepath_start</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;..\..\..\..\OUCRU\01NVa_Dengue\Adults&#39;</span>
 <span class="n">filename_Clinical</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;..\..\..\..\OUCRU\Clinical\v0.0.10\01nva_data_stacked_corrected.csv&#39;</span>
 <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">filepath_start</span><span class="p">)</span> <span class="c1"># fetching the list of records (currently only 3 for processing simplicity)</span>

 <span class="c1">#Loading Clinical Data to a Dataframe</span>

 <span class="n">Clinical</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename_Clinical</span><span class="p">)</span>

 <span class="c1">#defining constants</span>
 <span class="n">trim_amount</span> <span class="o">=</span> <span class="mi">300</span>
 <span class="n">hp_filt_params</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1">#(Hz, order)</span>
 <span class="n">lp_filt_params</span> <span class="o">=</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span> <span class="c1">#(Hz, order)</span>
 <span class="n">filter_type</span> <span class="o">=</span>  <span class="s1">&#39;butter&#39;</span>
 <span class="n">segment_length</span> <span class="o">=</span> <span class="mi">30</span>
 <span class="n">sampling_rate</span> <span class="o">=</span> <span class="mi">100</span>

 <span class="n">TERMINAL</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</td></tr></table></div>
<div class="sphx-glr-script-out highlight-pytb notranslate"><div class="highlight"><pre><span></span><span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;D:\FILES\Desktop\Dissertation ICL\Git\main\examples\Pre-processing\plot_SQI_Pandas_on_Multiple_Patients.py&quot;</span>, line <span class="m">31</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">vital_sqi.data.signal_io</span> <span class="kn">import</span> <span class="n">PPG_reader</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\vital_sqi\__init__.py&quot;</span>, line <span class="m">8</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">vital_sqi</span> <span class="kn">import</span> <span class="p">(</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\vital_sqi\data\__init__.py&quot;</span>, line <span class="m">8</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">vital_sqi.data.removal_utilities</span> <span class="kn">import</span> <span class="p">(</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\vital_sqi\data\removal_utilities.py&quot;</span>, line <span class="m">7</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">import</span> <span class="nn">pmdarima</span> <span class="k">as</span> <span class="nn">pm</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\pmdarima\__init__.py&quot;</span>, line <span class="m">51</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">.arima</span> <span class="kn">import</span> <span class="n">auto_arima</span><span class="p">,</span> <span class="n">ARIMA</span><span class="p">,</span> <span class="n">AutoARIMA</span><span class="p">,</span> <span class="n">StepwiseContext</span><span class="p">,</span> <span class="n">decompose</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\pmdarima\arima\__init__.py&quot;</span>, line <span class="m">5</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">.approx</span> <span class="kn">import</span> <span class="o">*</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\pmdarima\arima\approx.py&quot;</span>, line <span class="m">9</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">..utils.array</span> <span class="kn">import</span> <span class="n">c</span><span class="p">,</span> <span class="n">check_endog</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\pmdarima\utils\__init__.py&quot;</span>, line <span class="m">5</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">.array</span> <span class="kn">import</span> <span class="o">*</span>
  File <span class="nb">&quot;d:\files\desktop\dissertation icl\env\lib\site-packages\pmdarima\utils\array.py&quot;</span>, line <span class="m">13</span>, in <span class="n">&lt;module&gt;</span>
    <span class="kn">from</span> <span class="nn">._array</span> <span class="kn">import</span> <span class="n">C_intgrt_vec</span>
  File <span class="nb">&quot;pmdarima\utils\_array.pyx&quot;</span>, line <span class="m">1</span>, in <span class="n">init pmdarima.utils._array</span>
<span class="gr">ValueError</span>: <span class="n">numpy.ndarray size changed, may indicate binary incompatibility. Expected 88 from C header, got 80 from PyObject</span>
</pre></div>
</div>
</div>
<div class="section" id="defining-functions">
<h1>Defining Functions<a class="headerlink" href="#defining-functions" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="sd">&#39;&#39;&#39;</span>
<span class="sd"> #find the start of PPG from clinical Data #OLD VERSION, NOW WE ARE USING FILENAME</span>
<span class="sd"> def find_event_ppg_time(Clinical,Patient):</span>
<span class="sd">     row = Clinical[(Clinical.study_no == Patient) &amp; (Clinical.column == &#39;event_ppg&#39;) &amp; (Clinical.result == &#39;True&#39;)]</span>
<span class="sd">     return row[&#39;date&#39;].values</span>

<span class="sd"> &#39;&#39;&#39;</span>

 <span class="c1">#2162 does not have a start date</span>

 <span class="c1">#find the start of PPG from filename assuming that the clinical data was recorded at +0700 UTC</span>
 <span class="k">def</span> <span class="nf">find_ppg_start_time</span><span class="p">(</span><span class="n">absolute_filename</span><span class="p">):</span>
     <span class="n">absolute_filename</span> <span class="o">=</span> <span class="n">absolute_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">9</span><span class="p">]</span>
     <span class="n">absolute_filename</span> <span class="o">=</span> <span class="n">absolute_filename</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
     <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">absolute_filename</span><span class="p">,</span> <span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">%H%M%S.</span><span class="si">%f</span><span class="s1">&#39;</span><span class="p">)</span>





 <span class="c1">#======================================================</span>

 <span class="c1"># Band-pass filtering</span>

 <span class="sd">&#39;&#39;&#39;</span>
<span class="sd"> Band-pass filtering can be adjusted, maybe use a lower low-pass</span>
<span class="sd"> cutoff frequency @15-17Hz</span>

<span class="sd"> &#39;&#39;&#39;</span>
 <span class="c1">#Band pass filtering function</span>
 <span class="k">def</span> <span class="nf">bpf</span><span class="p">(</span><span class="n">signal</span><span class="p">):</span>

     <span class="c1">#OLD IMPLEMENTATION</span>
     <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">     hp_filt_params = (1, 1) #(Cutoff Hz, order)</span>
<span class="sd">     lp_filt_params = (20, 4) #( Cutoff Hz, order)</span>
<span class="sd">     sampling_rate = 100</span>
<span class="sd">     filter = BandpassFilter(band_type=&#39;butter&#39;, fs=sampling_rate)</span>
<span class="sd">     filtered_signal = filter.signal_highpass_filter(signal, cutoff=hp_filt_params[0], order=hp_filt_params[1])</span>
<span class="sd">     filtered_signal = filter.signal_lowpass_filter(filtered_signal, cutoff=lp_filt_params[0], order=lp_filt_params[1])</span>
<span class="sd">     &#39;&#39;&#39;</span>

     <span class="c1">#SCIPY IMPLEMENTATION FROM EXAMPLE</span>

     <span class="c1"># Configure high/low filters</span>
     <span class="n">bh</span><span class="p">,</span> <span class="n">ah</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;high&#39;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
     <span class="n">bl</span><span class="p">,</span> <span class="n">al</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">fs</span><span class="o">=</span><span class="n">sampling_rate</span><span class="p">,</span> <span class="n">btype</span><span class="o">=</span><span class="s1">&#39;low&#39;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
     <span class="c1"># Apply filters</span>
     <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">filtfilt</span><span class="p">(</span><span class="n">bh</span><span class="p">,</span> <span class="n">ah</span><span class="p">,</span> <span class="n">signal</span><span class="p">)</span>
     <span class="n">filtered_signal</span> <span class="o">=</span> <span class="n">si</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">bl</span><span class="p">,</span> <span class="n">al</span><span class="p">,</span> <span class="n">filtered_signal</span><span class="p">)</span>
     <span class="c1"># Return</span>

     <span class="k">return</span> <span class="n">filtered_signal</span>

 <span class="c1">#======================================================</span>

 <span class="c1"># SQI Functions Definitions</span>

 <span class="k">def</span> <span class="nf">PeakDetection</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="n">detector</span> <span class="o">=</span> <span class="n">PeakDetector</span><span class="p">()</span>
     <span class="n">peaks</span><span class="p">,</span> <span class="n">troughs</span> <span class="o">=</span> <span class="n">detector</span><span class="o">.</span><span class="n">ppg_detector</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="c1">#6 and 7 work the best</span>
     <span class="k">return</span> <span class="n">peaks</span><span class="p">,</span> <span class="n">troughs</span>

 <span class="c1">#Defining SQI Functions</span>

 <span class="k">def</span> <span class="nf">snr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="c1">#Signal to noise ratio</span>
     <span class="c1">#needs raw signal</span>
     <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sq</span><span class="o">.</span><span class="n">standard_sqi</span><span class="o">.</span><span class="n">signal_to_noise_sqi</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

 <span class="k">def</span> <span class="nf">zcr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="c1">#Zero Crossing Rate</span>
     <span class="c1">#Needs filtered signal</span>
     <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>

 <span class="k">def</span> <span class="nf">mcr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="c1">#Mean Crossing Rate</span>
     <span class="c1">#needs raw signal</span>
     <span class="k">return</span> <span class="n">zcr</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

 <span class="k">def</span> <span class="nf">perfusion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">):</span>
     <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>

 <span class="k">def</span> <span class="nf">correlogram</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="c1">#Correlogram</span>
     <span class="c1">#Needs filtered signal</span>
     <span class="k">return</span> <span class="n">sq</span><span class="o">.</span><span class="n">rpeaks_sqi</span><span class="o">.</span><span class="n">correlogram_sqi</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

 <span class="sd">&#39;&#39;&#39;</span>
<span class="sd"> MSQ values that are being calculated are too small, maybe peakdetectors need</span>
<span class="sd"> to be revisited?</span>
<span class="sd"> &#39;&#39;&#39;</span>
 <span class="k">def</span> <span class="nf">msq</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">peaks</span><span class="p">):</span>
     <span class="c1">#Dynamic Time Warping</span>
     <span class="c1">#Requires Filtered Signal and peaks</span>
      <span class="c1"># Return</span>
      <span class="k">return</span> <span class="n">sq</span><span class="o">.</span><span class="n">standard_sqi</span><span class="o">.</span><span class="n">msq_sqi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">peaks_1</span><span class="o">=</span><span class="n">peaks</span><span class="p">,</span> <span class="n">peak_detect2</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>

 <span class="sd">&#39;&#39;&#39;</span>
<span class="sd"> Below function is outputting an error, needs revisiting but not very important for this project</span>
<span class="sd"> &#39;&#39;&#39;</span>
 <span class="c1"># def dtw(x,troughs):</span>
 <span class="c1">#     #Dynamic Time Warping</span>
 <span class="c1">#     #Requires Filtered Signal and troughs and template selection 0-3 (0-2 for PPG)</span>
 <span class="c1">#     # Per beat</span>
 <span class="c1">#     dtw_list = sq.standard_sqi.per_beat_sqi(sqi_func=sq.dtw_sqi, troughs=troughs, signal=x, taper=True, template_type=1)</span>
 <span class="c1">#     # Return mean and standard deviation</span>
 <span class="c1">#     return [np.mean(dtw_list), np.std(dtw_list)]</span>

 <span class="c1">#======================================================</span>

 <span class="c1"># Function Computing SQIs</span>

 <span class="k">def</span> <span class="nf">sqi_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">raw</span><span class="p">,</span><span class="n">filtered</span><span class="p">,</span><span class="n">peaks</span><span class="p">,</span><span class="n">troughs</span><span class="p">):</span>

     <span class="c1">#Computing  all SQIs using the functions above</span>

     <span class="c1"># Information</span>
     <span class="n">dinfo</span> <span class="o">=</span> <span class="p">{</span>
         <span class="s1">&#39;PPG_w_s&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">PPG_Datetime</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="c1">#timedate window start</span>
         <span class="s1">&#39;PPG_w_f&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">PPG_Datetime</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="c1">#timedate window finish</span>
         <span class="s1">&#39;first&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
         <span class="s1">&#39;last&#39;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">idx</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
         <span class="s1">&#39;skew&#39;</span><span class="p">:</span> <span class="n">skew</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">raw</span><span class="p">]),</span>
         <span class="s1">&#39;entropy&#39;</span><span class="p">:</span> <span class="n">entropy</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">raw</span><span class="p">]),</span>
         <span class="s1">&#39;kurtosis&#39;</span><span class="p">:</span> <span class="n">kurtosis</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">raw</span><span class="p">]),</span>
         <span class="s1">&#39;snr&#39;</span><span class="p">:</span> <span class="n">snr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">raw</span><span class="p">]),</span>
         <span class="s1">&#39;mcr&#39;</span><span class="p">:</span> <span class="n">mcr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">raw</span><span class="p">]),</span>
         <span class="s1">&#39;zcr&#39;</span><span class="p">:</span> <span class="n">zcr</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">filtered</span><span class="p">]),</span>
         <span class="s1">&#39;msq&#39;</span><span class="p">:</span> <span class="n">msq</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">filtered</span><span class="p">],</span><span class="n">peaks</span><span class="p">),</span>
         <span class="s1">&#39;perfusion&#39;</span><span class="p">:</span> <span class="n">perfusion</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">raw</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="n">filtered</span><span class="p">]),</span>
         <span class="s1">&#39;correlogram&#39;</span><span class="p">:</span> <span class="n">correlogram</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">filtered</span><span class="p">]),</span>
         <span class="c1">#&#39;dtw&#39;: dtw(x[filtered],troughs)</span>
     <span class="p">}</span>
     <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">     When using dtw an empty signal error is presented that</span>
<span class="sd">     needs fixing, not sure why it does that</span>
<span class="sd">     &#39;&#39;&#39;</span>
     <span class="c1"># Return</span>
     <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">dinfo</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="loop-calculating-sqis-of-multiple-records-and-concatenating-results-into-a-single-dataframe">
<h1>Loop calculating SQIs of multiple records and concatenating results into a single dataframe<a class="headerlink" href="#loop-calculating-sqis-of-multiple-records-and-concatenating-results-into-a-single-dataframe" title="Permalink to this headline">Â¶</a></h1>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="sd">&#39;&#39;&#39;</span>
<span class="sd"> Looking through the directories and creating the SQI Dataframe for all patients.</span>
<span class="sd"> We first calculate each patients SQIs and the carry out the rejection process (latter not yet implementred).</span>
<span class="sd"> We then concatenate the SQIs along with other descriptors into a single SQI file.</span>
<span class="sd"> &#39;&#39;&#39;</span>

 <span class="c1">#reading the studies and automatically parsing the files</span>
 <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)):</span>
     <span class="n">filepath_end</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath_start</span><span class="p">,</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="sa">r</span><span class="s1">&#39;PPG&#39;</span><span class="p">))</span>
     <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">filepath_end</span><span class="p">)):</span>
         <span class="n">filename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filepath_start</span><span class="p">,</span><span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="sa">r</span><span class="s1">&#39;PPG&#39;</span><span class="p">,</span><span class="n">filepath_end</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FILENAME=========================================================================&quot;</span><span class="p">)</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FILENAME=========================================================================&quot;</span><span class="p">)</span>
         <span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

         <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
             <span class="c1">#print(data.PLETH)</span>
             <span class="c1">#print(data.IR_ADC)</span>
             <span class="c1">#print(data.TIMESTAMP_MS)</span>
             <span class="c1">#print(data.SPO2_PCT)</span>

         <span class="n">signals</span> <span class="o">=</span> <span class="n">data</span><span class="p">[[</span><span class="s2">&quot;PLETH&quot;</span><span class="p">,</span> <span class="s2">&quot;IR_ADC&quot;</span><span class="p">]]</span>

         <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
             <span class="c1"># In the future we will be using plotly, for better graphs but due to processing times</span>
             <span class="c1"># that change hasn&#39;t been made yet</span>
             <span class="n">plot_range</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
             <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_range</span><span class="p">,</span> <span class="n">signals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

         <span class="c1"># Setting the indexes for the raw data - adopted from examples</span>
         <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="o">.</span><span class="fm">__str__</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">_repr_base</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>

         <span class="c1"># Include column with index</span>
         <span class="n">signals</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

         <span class="c1">#creating the timedelta index using ms</span>
         <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;timedelta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">TIMESTAMP_MS</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;ms&#39;</span><span class="p">)</span>

         <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">         #Previous version during lookup in clinical data i.e. ppg_start</span>
<span class="sd">         #fetching the PPG start date</span>
<span class="sd">         PPG_start_date = find_ppg_start_time(Clinical, files[i][-8:])</span>

<span class="sd">         #converting to datetime format</span>
<span class="sd">         PPG_start_date = datetime.strptime(PPG_start_date[0], &#39;%Y-%m-%d %H:%M:%S&#39;)</span>
<span class="sd">         &#39;&#39;&#39;</span>

         <span class="c1">#finding datetime from filename and converting to datetime format</span>
         <span class="n">PPG_start_date</span> <span class="o">=</span> <span class="n">find_ppg_start_time</span><span class="p">(</span><span class="n">filepath_end</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

         <span class="c1">#creating the PPG Datetime column by taking the datetime and adding the timedeltas to it for each datapoint</span>
         <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;PPG_Datetime&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">PPG_start_date</span><span class="p">)</span>
         <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;PPG_Datetime&#39;</span><span class="p">]</span><span class="o">+=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">timedelta</span><span class="p">)</span>

         <span class="c1"># Set the timedelta index (keep numeric index too)</span>
         <span class="n">signals</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;timedelta&#39;</span><span class="p">)</span>

         <span class="c1"># Rename column to avoid confusion</span>
         <span class="n">signals</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;idx&#39;</span><span class="p">})</span>

         <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> Raw Signals:&quot;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>

             <span class="c1">#Plotting</span>
             <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
             <span class="n">signals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
             <span class="n">signals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

         <span class="c1"># Trimming the first and last 5 minutes</span>

         <span class="c1">#Defining the 5 minute offset</span>
         <span class="n">offset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

         <span class="c1">#Indexes - adopted from example</span>
         <span class="n">idxs</span> <span class="o">=</span> <span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> \
                 <span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">signals</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span><span class="p">)</span>

         <span class="c1">#Trimming</span>
         <span class="n">signals</span> <span class="o">=</span> <span class="n">signals</span><span class="p">[</span><span class="n">idxs</span><span class="p">]</span>

         <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Truncated Signals:&#39;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>


         <span class="c1"># RESAMPLE??</span>
         <span class="c1"># MISSING DATA INPUT??</span>
         <span class="c1"># TAPPERING??</span>

         <span class="c1">#Band-pass filtered signals</span>
         <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;PLETH_bpf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpf</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">1</span><span class="p">])</span>
         <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;IR_ADC_bpf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">bpf</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span><span class="mi">2</span><span class="p">])</span>

         <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Raw and Filtered Signals:&#39;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="n">signals</span><span class="p">)</span>

             <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
             <span class="n">axes</span> <span class="o">=</span> <span class="n">axes</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
             <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;PLETH_bpf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
             <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;IR_ADC_bpf&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

         <span class="c1">#Calculating peaks and troughs using peakdetector function for both filtered signals</span>
         <span class="n">peak_list_0</span><span class="p">,</span> <span class="n">trough_list_0</span> <span class="o">=</span> <span class="n">PeakDetection</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;PLETH_bpf&#39;</span><span class="p">])</span>
         <span class="n">peak_list_1</span><span class="p">,</span> <span class="n">trough_list_1</span> <span class="o">=</span> <span class="n">PeakDetection</span><span class="p">(</span><span class="n">signals</span><span class="p">[</span><span class="s1">&#39;IR_ADC_bpf&#39;</span><span class="p">])</span>

         <span class="c1"># Calculating SQIs for both signals 0 = Pleth and 1 = IR_ADC using both filtered and unfiltered signals</span>
         <span class="n">sqis_0</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;30s&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sqi_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;PLETH&#39;</span><span class="p">,</span><span class="s1">&#39;PLETH_bpf&#39;</span><span class="p">,</span> <span class="n">peak_list_0</span><span class="p">,</span> <span class="n">trough_list_0</span><span class="p">))</span>
         <span class="n">sqis_1</span> <span class="o">=</span> <span class="n">signals</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">freq</span><span class="o">=</span><span class="s1">&#39;30s&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">sqi_all</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s1">&#39;IR_ADC&#39;</span><span class="p">,</span><span class="s1">&#39;IR_ADC_bpf&#39;</span><span class="p">,</span> <span class="n">peak_list_1</span><span class="p">,</span> <span class="n">trough_list_1</span><span class="p">))</span>

         <span class="c1">#Displaying the SQIs per signal</span>
         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SQIs Signal 0 (Pleth):&quot;</span><span class="p">)</span>
         <span class="n">sqis_0</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">sqis_0</span><span class="p">)</span>

         <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SQIs Signal 1 (IR_ADC):&quot;</span><span class="p">)</span>
         <span class="n">sqis_1</span>
         <span class="nb">print</span><span class="p">(</span><span class="n">sqis_1</span><span class="p">)</span>
         <span class="c1">#removing duplicates</span>
         <span class="n">sqis_1</span> <span class="o">=</span> <span class="n">sqis_1</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;first&#39;</span><span class="p">,</span><span class="s1">&#39;last&#39;</span><span class="p">,</span> <span class="s1">&#39;PPG_w_s&#39;</span><span class="p">,</span> <span class="s1">&#39;PPG_w_f&#39;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

         <span class="c1"># Add window id to identify point of interest more easily</span>
         <span class="n">sqis_1</span><span class="p">[</span><span class="s1">&#39;w&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">sqis_1</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


         <span class="c1">#Final Formatting into a single DataFrame and Saving into a .csv file</span>

         <span class="c1">#Merging SQIs of different signals from the same record (Pleth and IR_ADC)</span>
         <span class="n">Signal_SQIs</span> <span class="o">=</span> <span class="n">sqis_0</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sqis_1</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;timedelta&#39;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;_0&#39;</span><span class="p">,</span> <span class="s1">&#39;_1&#39;</span><span class="p">))</span>

         <span class="c1">#Automatically fetching the study_no from the filename and including it in the DataFrame</span>
         <span class="n">Signal_SQIs</span><span class="p">[</span><span class="s1">&#39;study_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
         <span class="n">Signal_SQIs</span><span class="p">[</span><span class="s1">&#39;study_no_rec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>
         <span class="c1">#also doing it for the raw signals</span>
         <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;study_no&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">files</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="o">-</span><span class="mi">8</span><span class="p">:]</span>
         <span class="n">signals</span><span class="p">[</span><span class="s1">&#39;study_no_rec&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span>

         <span class="k">if</span> <span class="n">TERMINAL</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1"> Individual SQI Check:&#39;</span><span class="p">)</span>
             <span class="nb">print</span><span class="p">(</span><span class="n">Signal_SQIs</span><span class="p">)</span>

         <span class="sd">&#39;&#39;&#39;</span>

<span class="sd">         Discarding process to be added below.</span>

<span class="sd">         &#39;&#39;&#39;</span>
         <span class="c1">#RULE</span>
         <span class="n">Discarding_rules</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">Signal_SQIs</span><span class="p">[</span><span class="s1">&#39;skew_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="kc">True</span><span class="p">),</span> <span class="p">(</span><span class="n">Signal_SQIs</span><span class="p">[</span><span class="s1">&#39;skew_0&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="kc">True</span><span class="p">)]))</span>

         <span class="c1"># Apply rule (default False)</span>
         <span class="n">Signal_SQIs</span><span class="p">[</span><span class="s1">&#39;keep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">Discarding_rules</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Discarding_rules</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="kc">False</span><span class="p">)</span>

         <span class="c1"># Overwrite and keep all</span>
         <span class="n">Signal_SQIs</span><span class="p">[</span><span class="s1">&#39;keep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

         <span class="c1"># Keep all whose keep column value is true</span>
         <span class="n">Signal_SQIs</span> <span class="o">=</span> <span class="n">Signal_SQIs</span><span class="p">[</span><span class="n">Signal_SQIs</span><span class="o">.</span><span class="n">keep</span><span class="p">]</span>




         <span class="c1">#concatenating into a single dataframe for all studies</span>
         <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
             <span class="n">Complete_SQIs</span> <span class="o">=</span> <span class="n">Signal_SQIs</span>
             <span class="n">Raw_signals</span> <span class="o">=</span> <span class="n">signals</span>
         <span class="k">else</span><span class="p">:</span>
             <span class="n">Complete_SQIs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Complete_SQIs</span><span class="p">,</span> <span class="n">Signal_SQIs</span><span class="p">])</span>
             <span class="n">Raw_signals</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Raw_signals</span><span class="p">,</span> <span class="n">signals</span><span class="p">])</span>

 <span class="c1">#Saving to csv format</span>
 <span class="n">Complete_SQIs</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;..\..\..\..\OUCRU\Outputs\Complete_SQIs.csv&#39;</span><span class="p">)</span>
 <span class="n">Raw_signals</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;..\..\..\..\OUCRU\Outputs\Raw_signals.csv&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>SQI Requirements
example of the output</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>386
387
388</pre></div></td><td class="code"><div class="highlight"><pre><span></span> <span class="n">img</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;..\..\..\..\MISC\SQI_requirements.png&#39;</span><span class="p">)</span>
 <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;SQI Requirements&#39;</span><span class="p">)</span>
 <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p class="sphx-glr-timing"><strong>Total running time of the script:</strong> ( 0 minutes  9.216 seconds)</p>
<div class="sphx-glr-footer class sphx-glr-footer-example docutils container" id="sphx-glr-download-examples-pre-processing-plot-sqi-pandas-on-multiple-patients-py">
<div class="sphx-glr-download sphx-glr-download-python docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/c41a3eb5f4dfefae60b4ce15ac1a9f9f/plot_SQI_Pandas_on_Multiple_Patients.py"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Python</span> <span class="pre">source</span> <span class="pre">code:</span> <span class="pre">plot_SQI_Pandas_on_Multiple_Patients.py</span></code></a></p>
</div>
<div class="sphx-glr-download sphx-glr-download-jupyter docutils container">
<p><a class="reference download internal" download="" href="../../_downloads/1f0fdaa86dc5936dbdeca7cea0314cae/plot_SQI_Pandas_on_Multiple_Patients.ipynb"><code class="xref download docutils literal notranslate"><span class="pre">Download</span> <span class="pre">Jupyter</span> <span class="pre">notebook:</span> <span class="pre">plot_SQI_Pandas_on_Multiple_Patients.ipynb</span></code></a></p>
</div>
</div>
<p class="sphx-glr-signature"><a class="reference external" href="https://sphinx-gallery.github.io">Gallery generated by Sphinx-Gallery</a></p>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Philippos Arkis Hadjimarkou.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>